import request from "supertest";
import { describe, expect, it } from "vitest";
import { app } from "../support/app";

const credentialOfferQrCode =
	"data:image/png;base64,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";

describe("credential offer endpoint", () => {
	it("returns an error with a bad scope", async () => {
		const scope = "bad:scope";
		const response = await request(app).get(`/offer/${scope}`);

		expect(response.status).toBe(400);
		expect(response.body).to.deep.eq({
			error: "bad_request",
			error_description: "Invalid scope",
		});
	});

	[
		"eu.europa.ec.eudi.pid.1",
		"urn:credential:diploma",
		"urn:eu.europa.ec.eudi:pid:1:dc",
		"urn:eu.europa.ec.eudi:pid:1:vc",
		"urn:eu.europa.ec.eudi:por:1",
		"urn:eudi:ehic:1",
		"urn:eudi:pid:1:dc",
		"urn:eudi:pid:1:dc:jpt",
		"urn:eudi:pid:1:vc",
	].forEach((scope) => {
		it("returns", async () => {
			const response = await request(app).get(`/offer/${scope}`);

			expect(response.status).toBe(404);
			expect(response.body).to.deep.eq({
				error: "invalid_request",
				error_description: "credential not found",
			});
		});
	});

	it("returns a credential offer", async () => {
		const scope = "test:scope";
		const response = await request(app).get(`/offer/${scope}`);

		expect(response.status).toBe(200);
		expect(response.body).to.deep.eq({
			credentialOfferQrCode,
			credentialOfferUrl:
				"http://localhost:3000/?credential_offer=%7B%22credential_issuer%22%3A%22http%3A%2F%2Flocalhost%3A5000%22%2C%22credential_configuration_ids%22%3A%5B%22test%22%5D%2C%22grants%22%3A%7B%22authorization_code%22%3A%7B%22issuer_state%22%3A%22issuer_state%22%7D%7D%7D",
			supportedCredentialType: {},
		});
	});
});
